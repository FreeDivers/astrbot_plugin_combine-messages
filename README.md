# 消息合并插件 

这是一个 AstrBot 插件，用于合并收到的短时间内连续发送的消息,避免重复回复刷屏。

本插件由 Claude 3.7 Sonnet 制作，我向它提供了方向指导。

参考了 [**麦麦**](https://github.com/MaiM-with-u/MaiBot) 的消息合并机制。


人类打字<br>
都喜欢打几个字<br>
点一下发送<br>
打几个字<br>
点一下发送<br>
但是<br>
Bot会每一条<br>
都回复一下<br>
这个插件可以将短时间内连续收到的消息合为一条<br>
避免重复回复刷屏<br>
现在在 Bot 的眼里，收到的消息是这样的：<br>```人类打字，都喜欢打几个字，点一下发送，打几个字，点一下发送，但是，Bot会每一条，都回复一下```


欢迎大家使用并提出宝贵的意见，我会认真查看并改进的。

## 版本更新

### v1.1
- 增加了与 `astrbot_plugin_InitiativeDialogue` 插件的兼容性
- 新增对缺失 `message_id` 属性的消息处理能力，自动生成唯一标识
- 优化日志输出，提高调试能力
- 提高插件整体稳定性
- 增强了与各种平台适配器的兼容性，特别是aiocqhttp
- 添加初始强制延迟机制，解决快速连续发送消息时丢失早期消息的问题
- 优化消息处理流程，提高合并稳定性
- 增强消息拦截机制，确保被合并的消息不会被误处理
- 新增 `/combine_delay` 命令，允许用户调整初始延迟时间

### v1.0
- 首次发布

## 效果展示
![1](https://fultal.qinyan.org/Snipaste_2025-05-03_19-11-43.png)
![2](https://fultal.qinyan.org/Snipaste_2025-05-03_19-13-00.png)

## 功能特点

- 自动合并同一用户在短时间内发送的多条消息
- 使用逗号（，）连接多个文本消息
- 可自定义合并的时间间隔和初始延迟
- 支持开启/关闭消息合并功能
- 支持群聊和私聊消息合并
- 智能拦截已被合并的消息，避免重复处理
- 兼容多种插件，包括主动对话插件
- 优化的处理流程，防止快速连续消息丢失
- 支持多种平台适配器，包括NapCat和aiocqhttp

## 命令列表

- `/combine_on`: 开启消息合并功能
- `/combine_off`: 关闭消息合并功能
- `/combine_interval [秒数]`: 设置消息合并的时间间隔，范围为0.5-10秒，不填参数则显示当前设置
- `/combine_delay [秒数]`: 设置初始强制延迟，范围为0.1-2秒，不填参数则显示当前设置
- `/combine_test`: 测试插件是否正常工作

## 工作原理

1. 插件会缓存用户发送的消息
2. 每条消息都会有一个初始强制延迟（默认0.5秒），给快速发送的消息一个合并的机会
3. 当用户发送新消息后，会等待设定的时间间隔（默认3秒）
4. 如果在这段时间内没有新消息，则处理当前消息
5. 如果在处理前又收到了新消息，则把之前的消息标记为需要合并
6. 被标记为合并的消息会被自动拦截，不会单独处理
7. 最终会将连续的消息合并成一条，使用逗号分隔
8. 合并后的消息会交给AstrBot的LLM处理流程，生成一个综合回复

## 注意事项

- 默认合并时间间隔为3秒，初始强制延迟为0.5秒
- 命令消息（以"/"开头的消息）不会被合并
- 合并后的消息会自动交给LLM处理，不会直接发送给用户
- 插件包含早期消息拦截机制，确保被合并的消息不会重复处理
- 支持多种平台适配器，包括NapCat和aiocqhttp
- 如果有消息丢失问题，可以尝试增加初始延迟时间（使用 `/combine_delay` 命令）