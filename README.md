# 消息合并插件

本插件由 Cursor 制作，旨在通过合并来自同一用户的连续消息来减少消息刷屏，尤其是在用户快速发送多条短消息或图文消息时。合并后的消息将作为单条消息由 AstrBot 的大型语言模型（LLM）进行处理。

人类打字<br>
都喜欢打几个字<br>
点一下发送<br>
打几个字<br>
点一下发送<br>
但是<br>
Bot会每一条<br>
都回复一下<br>
这个插件可以将短时间内连续收到的消息合为一条<br>
避免重复回复刷屏<br>
现在在 Bot 的眼里，收到的消息是这样的：<br>```人类打字，都喜欢打几个字，点一下发送，打几个字，点一下发送，但是，Bot会每一条，都回复一下``

欢迎大家使用并提出宝贵的意见，我会认真查看并改进的。

## 展示
![1](https://fultal.qinyan.org/Snipaste_2025-05-03_19-11-43.png)
![2](https://fultal.qinyan.org/Snipaste_2025-05-03_19-13-00.png)

## 功能

- **自动合并**: 自动合并来自同一用户在短时间内的连续消息。
- **支持多种消息类型**: 支持合并文本和图片消息。
- **动态配置**: 您可以通过指令随时启用/禁用消息合并功能，并调整合并参数。
- **防止处理命令**: 自动忽略以 `/`, `!`, `.` 等符号开头的命令消息，避免干扰其他插件。

## 指令

插件提供以下指令来控制其行为：

- `/combine_on`: 开启消息合并功能。
- `/combine_off`: 关闭消息合并功能。
- `/combine_interval <秒数>`: 设置消息合并的等待时间。这是指在最后一条消息发送后，插件等待多长时间再执行合并。默认值为 3 秒。
  - 示例: `/combine_interval 5`
- `/combine_delay <秒数>`: 设置首次接收到消息后的初始延迟时间，然后才开始计时等待合并。这有助于捕获紧随其后的消息。默认值为 0.5 秒。
  - 示例: `/combine_delay 1`

## 更新日志

### v1.2
- 优化代码
- 修复图片消息的合并问题

### v1.1
- 增加了与 `astrbot_plugin_InitiativeDialogue` 插件的兼容性
- 新增对缺失 `message_id` 属性的消息处理能力，自动生成唯一标识
- 优化日志输出，提高调试能力
- 提高插件整体稳定性
- 增强了与各种平台适配器的兼容性，特别是aiocqhttp
- 添加初始强制延迟机制，解决快速连续发送消息时丢失早期消息的问题
- 优化消息处理流程，提高合并稳定性
- 增强消息拦截机制，确保被合并的消息不会被误处理
- 新增 `/combine_delay` 命令，允许用户调整初始延迟时间

### v1.0
- 首次发布

